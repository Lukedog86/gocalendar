<html>
<head>
<link rel="stylesheet" type="text/css" href="styles.css">
<script type="text/javascript" src="jkl-parsexml.js"></script>
<script type="text/javascript" src="dataFormat.js"></script>
<script>

var calendar = "http://www.google.com/calendar/render";
var pollInterval = 1000 * 30;  // 1 minute
var requestTimeout = 1000 * 5;  // 5 seconds
var oneDayInMilli = 1000 * 24 * 60 * 60; // 1 day
var defaultTZ = 'T00:00:00.000-04:00'; // midnight Eastern Daylight Time
var allDayEventDateFormat = 'YYYY-MM-DD';
var currentEntry;
var currentEntryIdx;
var entries = [];
var loggedIn = false;

function init() {
  window.setTimeout(startRequest, 0);
  cultureInfo = window.clientInformation.language;
  console.log("Culture is: " + cultureInfo);    
}

function $(elem) {
  return document.getElementById(elem);
}
 
function toArray(obj) {
  if ( obj.constructor == Array )
    return obj;
  return [obj];
}

function isAllDayEvent(dateStr) {
  return dateStr.length == allDayEventDateFormat.length;
}

function isRecurrencyEvent(entry)
{
	return entry['gd:recurrence'] != undefined;
}
 
function scheduleRequest() {
  window.setTimeout(startRequest, pollInterval);
}

// ajax stuff
function startRequest() {  
  getNextEntry(
    function(data) {
      toggleLoginState(true);
      updateEntries(data);
      updateToolstripEntry(0);
      scheduleRequest();
    },
    function() {
      toggleLoginState(false);
      scheduleRequest();
    }
  );
}

// ui stuff
function toggleLoginState(flag) {
  if ( flag ) {
    $("notLoggedIn").style.display = "none";
    $("loggedIn").style.display = "";
    loggedIn = true;
  } else {
    $("loggedIn").style.display = "none";
    $("notLoggedIn").style.display = ""; 
    loggedIn = false;
  }
}

function updateEntries(data) {
  entries = [];
  if ( data.feed.entry == undefined )
  {
	console.log('GoCalendar: NO data fetched.');
    sadFace();
	return;
  }
  
  var calData = toArray(data.feed.entry); 
 
  for ( var i = 0, len = calData.length; i < len; ++i ) {
	var startTime = undefined;
	var endTime = undefined;
    var calEntry = calData[i];
	
	if ( isRecurrencyEvent(calEntry) )
	{
		var when = toArray(calEntry['gd:when']);
		console.log("Recurrency Event: " + calEntry);
		for ( var j = 0, rlen = when.length; j < rlen; ++j )
		{
			startTime = when[j].startTime;
			endTime = when[j].endTime;
			
			addToEntryList(
				calEntry.title['#text'],
				startTime,
				endTime,
				calEntry['gd:where'].valueString,
				calEntry.id,
				j);
		}
	}
	else
	{	
		startTime = calEntry['gd:when'].startTime;
		endTime = calEntry['gd:when'].endTime;
		
		addToEntryList(
			calEntry.title['#text'],
			startTime,
			endTime,
			calEntry['gd:where'].valueString,
			calEntry.id,
			0);		
	}
	
  }
  console.log(entries.length + " entries found.");
}

function addToEntryList(etitle, estart, eend, ewhere, eid, erecur)
{	
    var startDate = new Date();
    var endDate = new Date();
	
    // All day events come back in YYYY/MM/DD format. Append a default 
    // timezone so that the dates can be properly resolved.
    if (isAllDayEvent(estart))
      estart += defaultTZ;
	
    if (isAllDayEvent(eend))
      eend += defaultTZ;

    startDate.setISO8601(estart);
    endDate.setISO8601(eend);

    var entry = { 
        title: etitle,
        start: startDate,
        end: endDate,
        where: ewhere,
        id: eid,
		recid : erecur
    }
	
	var idx = entries.length;
    entries[idx] = entry;
    console.log("idx: " + idx + "entry: " + entry);
}

function updateToolstripEntry(idx) {
  if ( idx >= 0 && idx < entries.length ) // check IDX
  {
	  if (currentEntry == undefined || currentEntry.id != entries[idx].id || currentEntry.recid != entries[idx].recid) {
		currentEntry = entries[idx];
		currentEntryIdx = idx;
		startFlip();
	  }
  }
}

function goToCalendar() {
  chrome.tabs.create({url: calendar});
}

// animation
function startFlip() {
  $("nextEntry").className = 'mid-flip';
  setTimeout(midFlip, 500);
}

function midFlip() {
  var nextEntryText = currentEntry.title + " @ " + 
    shortDateString(currentEntry.start, currentEntry.end)
  $("nextEntry").className = 'post-flip';  
  $("nextEntry").innerHTML = nextEntryText;
  setTimeout(endFlip, 500);
}

function endFlip() {
  $("nextEntry").className = 'base-flip';  
}

function sadFace()
{
	$("nextEntry").innerHTML = ":("; 
}

function shortDateString(start, end) {
  var format;
  switch ( cultureInfo ) {
    case 'en-US':
      format = 'm/d/yy h:MM TT';
      break;
    default:
      format = 'dd/mm/yy HH:MM';
  }
  // If the event is an all day event, don't show the time.
  if ( (end - start) == oneDayInMilli )
    format = format.substring(0, format.indexOf(' '));
  return start.format(format);
}

function showNextEntry() {
  if ( !loggedIn ) return;
  var nextIdx = ( currentEntryIdx + 1 ) % entries.length;
  updateToolstripEntry(nextIdx);
}

function showPrevEntry() {
  if ( !loggedIn ) return;
  var prevIdx = ( currentEntryIdx - 1 ) % entries.length;
  updateToolstripEntry(prevIdx);
}

function btnOver() {
    var c = currentEntry;
	if ( c != undefined )
	{
		$("currententry").title = c.title + "\nStart: " + c.start +
			"\nEnd: " + c.end + "\nWhere: " + c.where;
	}
}

/* API */
var calendarBasicView ="https://www.google.com/calendar/feeds/default/private/full?futureevents=true&orderby=starttime&sortorder=ascending";

function getNextEntry(onSuccess, onError) {
    var xhr = new XMLHttpRequest();
    
    var abortTimerId = window.setTimeout(function() {
        xhr.abort();
        onError();
    }, requestTimeout);  

    function handleSuccess(data) {        
        window.clearTimeout(abortTimerId);
        onSuccess(data);
    }    
    
    function handleError() {
        window.clearTimeout(abortTimerId);
        onError();
    }    
    
    try {
        console.log("request..");
        var xml = new JKL.ParseXML(calendarBasicView);
        xml.async( handleSuccess );
        xml.parse();
    } catch(e) {
        console.log("ex: " + e);
        console.error("exception: " + e);
        handleError();
    }    
}

</script>
</head>
<body onload="init()">

    <div id="prev" class="toolstrip-button" onclick="showPrevEntry()">
      <span id="prevtext">&lt;</span>
    </div>    
    
    <div id="currententry" class="toolstrip-button" onclick="goToCalendar()" onmouseover="btnOver()">
        <img src="calendar.png" style="width:auto; height:auto">
        <span id="notLoggedIn" style="display:none;">Login</span>
        <span id="loggedIn"><span style="display: inline-block;" id="nextEntry" class="base-flip"></span></span>
    </div>    
    
    <div id="next" class="toolstrip-button" onclick="showNextEntry()">
        <span id="nexttext">&gt;</span>
    </div>    
</body>
</html>
