<html>
<head>
<link rel="stylesheet" type="text/css" href="styles.css">
<script type="text/javascript" src="jkl-parsexml.js"></script>
<script>
var calendar = "http://www.google.com/calendar/render";
var pollInterval = 1000 * 30;  // 1 minute
var requestTimeout = 1000 * 5;  // 5 seconds
var currentEntry;
var currentEntryIdx;
var entries = [];
var loggedIn = false;

function init() {
  window.setTimeout(startRequest, 0);
}

function scheduleRequest() {
  window.setTimeout(startRequest, pollInterval);
}

// ajax stuff
function startRequest() {  
  getNextEntry(
    function(data) {
      toggleLoggedInState();
      updateEntries(data);
      updateToolstripEntry(0);
      scheduleRequest();
    },
    function() {
      toggleLoggedOutState();
      scheduleRequest();
    }
  );
}

// ui stuff
function toggleLoggedInState() {
  document.getElementById("notLoggedIn").style.display = "none";
  document.getElementById("loggedIn").style.display = "";
  loggedIn = true;
}

function toggleLoggedOutState() {
  document.getElementById("loggedIn").style.display = "none";
  document.getElementById("notLoggedIn").style.display = "";
  loggedIn = false;
}

function updateEntries(data)
{
    entries = [];
    for ( var i = 0; i < data.feed.entry.length; ++i )
    {
        var d_start = new Date();
        var d_end = new Date();
        d_start.setISO8601(data.feed.entry[i]['gd:when'].startTime);
        d_end.setISO8601(data.feed.entry[i]['gd:when'].endTime);
        
        var entry = 
        { 
            title: data.feed.entry[i].title['#text'],
            start: d_start,
            end: d_end,
            where: data.feed.entry[i]['gd:where'].valueString,
            id: data.feed.entry[i].id
        }
        
        entries[i] = entry;
        console.log(entry);
    }
    
    console.log(entries.length + " entries found.");
}

function updateToolstripEntry(idx) {
  if (currentEntry == undefined || currentEntry.id != entries[idx].id) {
    currentEntry = entries[idx];
    currentEntryIdx = idx;
    startFlip();
  }
}

function goToCalendar() {
  chrome.tabs.create({url: calendar});
}

// animation
function startFlip() {
  document.getElementById("nextEntry").className = 'mid-flip';
  setTimeout(midFlip, 500);
}

function midFlip() {
  document.getElementById("nextEntry").className = 'post-flip';  
  document.getElementById("nextEntry").innerHTML = currentEntry.title + " @ " + shortDateString(currentEntry.start);
  setTimeout(endFlip, 500);
}

function endFlip() {
  document.getElementById("nextEntry").className = 'base-flip';  
}

function shortDateString(date)
{
    return (date.getDay()+1) + '/' + (date.getMonth()+1) + '/' + date.getFullYear() + ' ' + date.getHours() + ':' + date.getMinutes();
}

function showNextEntry()
{
    if ( loggedIn )
    {
        var nextIdx = ( currentEntryIdx + 1 ) % entries.length;
        updateToolstripEntry(nextIdx);
    }  
}

function showPrevEntry()
{
    if ( loggedIn )
    {
        var prevIdx = ( currentEntryIdx - 1 ) % entries.length;
        updateToolstripEntry(prevIdx);
    }  
}

function btnOver() 
{
	var c = currentEntry;
	document.getElementById("currententry").title = c.title + "\nStart: " + c.start + "\nEnd: " + c.end + "\nWhere: " + c.where;
}

/* API */
var calendarBasicView ="https://www.google.com/calendar/feeds/default/private/full?futureevents=true&orderby=starttime&sortorder=ascending";

function getNextEntry(onSuccess, onError) {
    var xhr = new XMLHttpRequest();
    
    var abortTimerId = window.setTimeout(function() {
        xhr.abort();
        onError();
    }, requestTimeout);  

    function handleSuccess(data) {        
        window.clearTimeout(abortTimerId);
        onSuccess(data);
    }    
    
    function handleError() {
        window.clearTimeout(abortTimerId);
        onError();
    }    
    
    try {
        console.log("request..");
 
        var xml = new JKL.ParseXML(calendarBasicView);
        xml.async( handleSuccess );
        xml.parse();

        
    }    
    catch(e) {
        console.log("ex: " + e);
        console.error("exception: " + e);
        handleError();
    }    
}

Date.prototype.setISO8601 = function (string) {
    var regexp = "([0-9]{4})(-([0-9]{2})(-([0-9]{2})" +
        "(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\.([0-9]+))?)?" +
        "(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?";
    var d = string.match(new RegExp(regexp));

    var offset = 0;
    var date = new Date(d[1], 0, 1);

    if (d[3]) { date.setMonth(d[3] - 1); }
    if (d[5]) { date.setDate(d[5]); }
    if (d[7]) { date.setHours(d[7]); }
    if (d[8]) { date.setMinutes(d[8]); }
    if (d[10]) { date.setSeconds(d[10]); }
    if (d[12]) { date.setMilliseconds(Number("0." + d[12]) * 1000); }
    if (d[14]) {
        offset = (Number(d[16]) * 60) + Number(d[17]);
        offset *= ((d[15] == '-') ? 1 : -1);
    }

    offset -= date.getTimezoneOffset();
    time = (Number(date) + (offset * 60 * 1000));
    this.setTime(Number(time));
}

</script>
</head>
<body onload="init()">

	<div id="prev" class="toolstrip-button" onclick="showPrevEntry()">
	  <span id="prevtext">&lt;</span>
	</div>	
	
	<div id="currententry" class="toolstrip-button" onclick="goToCalendar()" onmouseover="btnOver()">
		<img src="calendar.png" style="width:auto; height:auto">
		<span id="notLoggedIn" style="display:none;">Login</span>
		<span id="loggedIn"><span style="display: inline-block;" id="nextEntry" class="base-flip"></span></span>
	</div>    
	
	<div id="next" class="toolstrip-button" onclick="showNextEntry()">
		<span id="nexttext">&gt;</span>
	</div>	
</body>
</html>
